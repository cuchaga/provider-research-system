%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#8B5CF6', 'primaryTextColor': '#fff', 'primaryBorderColor': '#7C3AED', 'lineColor': '#F59E0B', 'secondaryColor': '#10B981', 'tertiaryColor': '#1F2937'}}}%%

flowchart TB
    subgraph INPUT["üì• INPUT"]
        USER[/"üë§ User Query"/]
        CTX[("üß† Context<br/>‚Ä¢ Conversation History<br/>‚Ä¢ User Location<br/>‚Ä¢ Last Result")]
    end

    subgraph LAYER0["üîÆ LAYER 0: PROMPT INTERPRETATION<br/>~800 tokens"]
        L0_PARSE["Parse Intent<br/>search | add | compare | list"]
        L0_ENTITY["Extract Entities<br/>‚Ä¢ Provider names<br/>‚Ä¢ Locations<br/>‚Ä¢ Filters"]
        L0_RESOLVE["Resolve References<br/>‚Ä¢ 'this' ‚Üí entity<br/>‚Ä¢ 'that' ‚Üí entity<br/>‚Ä¢ 'near me' ‚Üí location"]
        L0_PLAN["Create Plan<br/>‚Ä¢ Single step<br/>‚Ä¢ Multi-step"]
        L0_CHECK{"Clarification<br/>Needed?"}
    end

    subgraph LAYER1["‚ö° LAYER 1: DATABASE SEARCH<br/>0 tokens (rule-based)"]
        L1_NPI["Exact NPI Match"]
        L1_NAME["Exact Name Match"]
        L1_LIKE["SQL LIKE Pattern"]
        L1_FTS["Full-Text Search"]
        L1_FUZZY["Levenshtein Fuzzy<br/>threshold: 80%"]
        L1_CHECK{"Match<br/>‚â•80%?"}
    end

    subgraph LAYER2["üß© LAYER 2: SEMANTIC MATCHING<br/>~500 tokens"]
        L2_ABBREV["Abbreviation Expansion<br/>CK ‚Üí Comfort Keepers"]
        L2_PARENT["Parent/Subsidiary<br/>Matching"]
        L2_DBA["DBA Name<br/>Resolution"]
        L2_CHECK{"Match<br/>‚â•0.7?"}
    end

    subgraph LAYER3["üåê LAYER 3: WEB RESEARCH<br/>~2,000-5,000 tokens"]
        L3_SEARCH["Web Search<br/>'[provider] locations [state]'"]
        L3_FETCH["Fetch Content<br/>HTML/Text"]
        L3_EXTRACT["LLM Extraction<br/>‚Ä¢ Names<br/>‚Ä¢ Addresses<br/>‚Ä¢ Phones"]
    end

    subgraph LAYER4["üîÑ LAYER 4: DEDUPLICATION<br/>~1,000 tokens"]
        L4_RULE["Rule-Based Pass<br/>‚Ä¢ Phone matching<br/>‚Ä¢ Address normalization"]
        L4_LLM["LLM Pass (Edge Cases)<br/>‚Ä¢ Same building<br/>‚Ä¢ Franchise logic"]
    end

    subgraph LAYER5["‚úÖ LAYER 5: NPI VALIDATION<br/>~500 tokens"]
        L5_API["NPI Registry<br/>API Search"]
        L5_MATCH["LLM Matching<br/>‚Ä¢ Name correlation<br/>‚Ä¢ Address proximity"]
    end

    subgraph STORAGE["üíæ STORAGE"]
        DB[(PostgreSQL<br/>providers<br/>search_history<br/>research_sessions)]
    end

    subgraph OUTPUT["üì§ OUTPUT"]
        RESULT[/"üìã Results<br/>‚Ä¢ Providers found<br/>‚Ä¢ Confidence scores<br/>‚Ä¢ Execution trace"/]
        CLARIFY[/"‚ùì Clarification<br/>Request"/]
    end

    %% Flow connections
    USER --> L0_PARSE
    CTX -.-> L0_RESOLVE
    
    L0_PARSE --> L0_ENTITY
    L0_ENTITY --> L0_RESOLVE
    L0_RESOLVE --> L0_PLAN
    L0_PLAN --> L0_CHECK
    
    L0_CHECK -->|Yes| CLARIFY
    L0_CHECK -->|No| L1_NPI
    
    L1_NPI --> L1_NAME
    L1_NAME --> L1_LIKE
    L1_LIKE --> L1_FTS
    L1_FTS --> L1_FUZZY
    L1_FUZZY --> L1_CHECK
    
    L1_CHECK -->|Yes| RESULT
    L1_CHECK -->|No| L2_ABBREV
    
    L2_ABBREV --> L2_PARENT
    L2_PARENT --> L2_DBA
    L2_DBA --> L2_CHECK
    
    L2_CHECK -->|Yes| RESULT
    L2_CHECK -->|No| L3_SEARCH
    
    L3_SEARCH --> L3_FETCH
    L3_FETCH --> L3_EXTRACT
    L3_EXTRACT --> L4_RULE
    
    L4_RULE --> L4_LLM
    L4_LLM --> L5_API
    
    L5_API --> L5_MATCH
    L5_MATCH --> DB
    DB --> RESULT

    %% Styling
    classDef inputStyle fill:#3B82F6,stroke:#1D4ED8,color:#fff
    classDef layer0Style fill:#8B5CF6,stroke:#7C3AED,color:#fff
    classDef layer1Style fill:#10B981,stroke:#059669,color:#fff
    classDef layer2Style fill:#F59E0B,stroke:#D97706,color:#fff
    classDef layer3Style fill:#EF4444,stroke:#DC2626,color:#fff
    classDef layer4Style fill:#EC4899,stroke:#DB2777,color:#fff
    classDef layer5Style fill:#06B6D4,stroke:#0891B2,color:#fff
    classDef storageStyle fill:#6366F1,stroke:#4F46E5,color:#fff
    classDef outputStyle fill:#22C55E,stroke:#16A34A,color:#fff
    classDef decisionStyle fill:#FBBF24,stroke:#F59E0B,color:#000

    class USER,CTX inputStyle
    class L0_PARSE,L0_ENTITY,L0_RESOLVE,L0_PLAN layer0Style
    class L1_NPI,L1_NAME,L1_LIKE,L1_FTS,L1_FUZZY layer1Style
    class L2_ABBREV,L2_PARENT,L2_DBA layer2Style
    class L3_SEARCH,L3_FETCH,L3_EXTRACT layer3Style
    class L4_RULE,L4_LLM layer4Style
    class L5_API,L5_MATCH layer5Style
    class DB storageStyle
    class RESULT,CLARIFY outputStyle
    class L0_CHECK,L1_CHECK,L2_CHECK decisionStyle
